<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Scoring Dashboard | SolanaYield</title>
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --neon-green: #00ff88;
      --neon-cyan: #00d4ff;
      --neon-yellow: #ffcc00;
      --neon-red: #ff3366;
      --neon-purple: #b366ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .aegis-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(179, 102, 255, 0.1);
      border: 1px solid var(--neon-purple);
      border-radius: 9999px;
      font-size: 0.875rem;
      color: var(--neon-purple);
    }

    .nav-links {
      display: flex;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .nav-links a:hover { color: var(--neon-cyan); }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .stat-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.green { color: var(--neon-green); }
    .stat-value.yellow { color: var(--neon-yellow); }
    .stat-value.red { color: var(--neon-red); }
    .stat-value.cyan { color: var(--neon-cyan); }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-body {
      padding: 1.5rem;
    }

    .risk-grid {
      display: grid;
      gap: 1rem;
    }

    .risk-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .risk-item:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: var(--neon-cyan);
    }

    .risk-item-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .risk-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      background: rgba(255, 255, 255, 0.05);
    }

    .risk-info h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .risk-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .risk-item-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .risk-score {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
    }

    .risk-number {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .risk-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .risk-very-low { color: var(--neon-green); }
    .risk-low { color: var(--neon-green); }
    .risk-medium { color: var(--neon-yellow); }
    .risk-high { color: var(--neon-red); }
    .risk-very-high { color: var(--neon-red); }

    .risk-label.risk-very-low { background: rgba(0, 255, 136, 0.1); }
    .risk-label.risk-low { background: rgba(0, 255, 136, 0.1); }
    .risk-label.risk-medium { background: rgba(255, 204, 0, 0.1); }
    .risk-label.risk-high { background: rgba(255, 51, 102, 0.1); }
    .risk-label.risk-very-high { background: rgba(255, 51, 102, 0.1); }

    .factor-grid {
      display: grid;
      gap: 0.75rem;
    }

    .factor-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .factor-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .factor-bar-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .factor-bar {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .factor-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .factor-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 2rem;
      text-align: right;
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .insight-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .insight-item.positive {
      border-left: 3px solid var(--neon-green);
    }

    .insight-item.warning {
      border-left: 3px solid var(--neon-yellow);
    }

    .insight-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .aegis-watermark {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: var(--neon-purple);
      font-weight: 600;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--neon-cyan);
      text-decoration: none;
    }

    .footer a:hover { text-decoration: underline; }

    @media (max-width: 1024px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .header h1 { font-size: 1.25rem; }
      .stat-value { font-size: 1.5rem; }
      .modal { padding: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è Risk Scoring Dashboard</h1>
      <div class="aegis-badge">
        <span>‚ö°</span>
        <span>Powered by AEGIS Intelligence</span>
      </div>
    </div>

    <div class="nav-links">
      <a href="/">Dashboard</a>
      <a href="/risk-monitor.html">Yield Monitor</a>
      <a href="/api/risk?action=protocols" target="_blank">API</a>
    </div>

    <div class="stats-row" style="margin-top: 1.5rem;">
      <div class="stat-card">
        <span class="stat-label">Protocols Tracked</span>
        <span class="stat-value cyan" id="stat-protocols">--</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Avg Risk Score</span>
        <span class="stat-value" id="stat-avg-risk">--</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">AEGIS Enhanced</span>
        <span class="stat-value green" id="stat-aegis">--</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Low Risk Pools</span>
        <span class="stat-value green" id="stat-low-risk">--</span>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h2>üèõÔ∏è Protocol Risk Profiles</h2>
        </div>
        <div class="card-body">
          <div class="risk-grid" id="protocols-grid">
            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
              Loading protocols...
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>üìä Risk Distribution</h2>
        </div>
        <div class="card-body">
          <canvas id="risk-chart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üéØ Top Risk-Adjusted Opportunities</h2>
        <span style="font-size: 0.85rem; color: var(--text-muted);">Sorted by Sharpe ratio</span>
      </div>
      <div class="card-body">
        <div id="opportunities-list" style="display: grid; gap: 0.75rem;">
          <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
            Loading opportunities...
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>
        Risk scores combine smart contract audits, TVL depth, historical incidents, protocol age, and asset volatility.
        <br>
        Enhanced with <a href="https://colosseum.com/agent-hackathon" target="_blank">AEGIS Analyst Agent</a> intelligence.
      </p>
    </div>
  </div>

  <!-- Protocol Details Modal -->
  <div class="modal" id="protocol-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <script>
    const protocolIcons = {
      'kamino': 'üèõÔ∏è',
      'drift': 'üåä',
      'jito': 'üéØ',
      'marinade': 'ü•©',
      'mango': 'ü•≠',
      'raydium': '‚ö°',
      'orca': 'üêã',
    };

    let protocols = {};
    let opportunities = [];

    function getRiskLevel(score) {
      if (score < 20) return 'very-low';
      if (score < 35) return 'low';
      if (score < 50) return 'medium';
      if (score < 70) return 'high';
      return 'very-high';
    }

    function getRiskLabel(score) {
      if (score < 20) return 'Very Low';
      if (score < 35) return 'Low';
      if (score < 50) return 'Medium';
      if (score < 70) return 'High';
      return 'Very High';
    }

    function getFactorColor(score) {
      if (score < 20) return 'var(--neon-green)';
      if (score < 40) return '#66ff99';
      if (score < 60) return 'var(--neon-yellow)';
      if (score < 80) return '#ff9966';
      return 'var(--neon-red)';
    }

    async function fetchProtocols() {
      try {
        const res = await fetch('/api/risk?action=protocols');
        const data = await res.json();
        protocols = data.profiles;
        renderProtocols();
        updateStats();
      } catch (err) {
        console.error('Failed to fetch protocols:', err);
      }
    }

    async function fetchOpportunities() {
      try {
        const res = await fetch('/api/risk?action=analyze&risk=medium&top=15');
        const data = await res.json();
        opportunities = data.recommendations;
        renderOpportunities();
        renderChart();
      } catch (err) {
        console.error('Failed to fetch opportunities:', err);
      }
    }

    function renderProtocols() {
      const grid = document.getElementById('protocols-grid');
      
      const sorted = Object.entries(protocols)
        .filter(([key]) => key !== 'unknown')
        .sort(([,a], [,b]) => a.baseRiskScore - b.baseRiskScore);

      grid.innerHTML = sorted.map(([key, p]) => {
        const riskLevel = getRiskLevel(p.baseRiskScore);
        const riskLabel = getRiskLabel(p.baseRiskScore);
        const icon = protocolIcons[key] || 'üì¶';
        const auditInfo = p.audited ? `${p.auditFirms.join(', ')}` : 'Not audited';
        
        return `
          <div class="risk-item" onclick="showProtocolDetails('${key}')">
            <div class="risk-item-left">
              <div class="risk-icon">${icon}</div>
              <div class="risk-info">
                <h3>${p.name}</h3>
                <div class="risk-meta">${auditInfo}</div>
              </div>
            </div>
            <div class="risk-item-right">
              <div class="risk-score">
                <div class="risk-number risk-${riskLevel}">${p.baseRiskScore}</div>
                <div class="risk-label risk-${riskLevel}">${riskLabel}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderOpportunities() {
      const list = document.getElementById('opportunities-list');
      
      list.innerHTML = opportunities.slice(0, 10).map(o => {
        const riskLevel = getRiskLevel(o.riskScore);
        const riskLabel = getRiskLabel(o.riskScore);
        const icon = protocolIcons[o.protocol.toLowerCase()] || 'üì¶';
        
        return `
          <div class="risk-item" onclick="showOpportunityDetails('${o.protocol}', '${o.asset}')">
            <div class="risk-item-left">
              <div class="risk-icon">${icon}</div>
              <div class="risk-info">
                <h3>${o.protocol} ¬∑ ${o.asset}</h3>
                <div class="risk-meta">
                  Raw APY: ${o.rawApy.toFixed(2)}% ‚Üí 
                  Risk-Adjusted: ${o.riskAdjustedApy.toFixed(2)}% ¬∑ 
                  Sharpe: ${o.sharpeRatio.toFixed(2)}
                </div>
              </div>
            </div>
            <div class="risk-item-right">
              <div class="risk-score">
                <div class="risk-number risk-${riskLevel}">${o.riskScore}</div>
                <div class="risk-label risk-${riskLevel}">${riskLabel}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderChart() {
      // Simple bar chart using divs (no canvas library needed)
      const canvas = document.getElementById('risk-chart');
      const container = canvas.parentElement;
      
      const distribution = {
        'Very Low (<20)': 0,
        'Low (20-35)': 0,
        'Medium (35-50)': 0,
        'High (50-70)': 0,
        'Very High (70+)': 0,
      };

      opportunities.forEach(o => {
        const score = o.riskScore;
        if (score < 20) distribution['Very Low (<20)']++;
        else if (score < 35) distribution['Low (20-35)']++;
        else if (score < 50) distribution['Medium (35-50)']++;
        else if (score < 70) distribution['High (50-70)']++;
        else distribution['Very High (70+)']++;
      });

      const max = Math.max(...Object.values(distribution));
      const colors = ['var(--neon-green)', 'var(--neon-green)', 'var(--neon-yellow)', 'var(--neon-red)', 'var(--neon-red)'];
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          ${Object.entries(distribution).map(([label, count], i) => `
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div style="min-width: 120px; font-size: 0.85rem; color: var(--text-secondary);">${label}</div>
              <div style="flex: 1; height: 24px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${max > 0 ? (count / max * 100) : 0}%; background: ${colors[i]}; border-radius: 4px; transition: width 0.3s;"></div>
              </div>
              <div style="min-width: 40px; text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${colors[i]};">${count}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function updateStats() {
      const protocolCount = Object.keys(protocols).filter(k => k !== 'unknown').length;
      document.getElementById('stat-protocols').textContent = protocolCount;

      if (opportunities.length > 0) {
        const avgRisk = opportunities.reduce((s, o) => s + o.riskScore, 0) / opportunities.length;
        const avgRiskEl = document.getElementById('stat-avg-risk');
        avgRiskEl.textContent = Math.round(avgRisk);
        avgRiskEl.className = `stat-value risk-${getRiskLevel(avgRisk)}`;

        const aegisCount = opportunities.filter(o => o.aegisEnhanced).length;
        document.getElementById('stat-aegis').textContent = aegisCount;

        const lowRiskCount = opportunities.filter(o => o.riskScore < 35).length;
        document.getElementById('stat-low-risk').textContent = lowRiskCount;
      }
    }

    async function showProtocolDetails(protocolKey) {
      const protocol = protocols[protocolKey];
      const modal = document.getElementById('protocol-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.innerHTML = `${protocolIcons[protocolKey] || 'üì¶'} ${protocol.name}`;

      // Fetch AEGIS data if available
      let aegisData = null;
      try {
        const res = await fetch(`/api/risk?action=aegis&protocol=${protocolKey}`);
        if (res.ok) {
          aegisData = await res.json();
        }
      } catch (err) {
        console.error('AEGIS data not available:', err);
      }

      const riskScore = aegisData ? aegisData.aegisRiskScore : protocol.baseRiskScore;
      const riskLevel = getRiskLevel(riskScore);
      const riskLabel = getRiskLabel(riskScore);

      body.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
            <div>
              <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Overall Risk Score</div>
              <div class="risk-number risk-${riskLevel}" style="font-size: 2.5rem;">${riskScore}</div>
              <div class="risk-label risk-${riskLevel}">${riskLabel}</div>
            </div>
            ${aegisData ? `
              <div class="aegis-watermark" style="font-size: 0.9rem;">
                <span>üõ°Ô∏è</span>
                <span>AEGIS ${(aegisData.confidence * 100).toFixed(0)}% confidence</span>
              </div>
            ` : ''}
          </div>

          ${aegisData && aegisData.factors ? `
            <div>
              <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Risk Factors</h3>
              <div class="factor-grid">
                ${Object.entries(aegisData.factors).map(([key, value]) => `
                  <div class="factor-row">
                    <div class="factor-name">${key.replace(/([A-Z])/g, ' $1').trim()}</div>
                    <div class="factor-bar-container">
                      <div class="factor-bar">
                        <div class="factor-bar-fill" style="width: ${value}%; background: ${getFactorColor(value)}"></div>
                      </div>
                      <div class="factor-value" style="color: ${getFactorColor(value)}">${value}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div>
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Protocol Information</h3>
            <div style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Audit Status:</span>
                <span>${protocol.audited ? '‚úÖ Audited' : '‚ùå Not audited'}</span>
              </div>
              ${protocol.auditFirms ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-secondary);">Audit Firms:</span>
                  <span>${protocol.auditFirms.join(', ')}</span>
                </div>
              ` : ''}
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Launch Date:</span>
                <span>${new Date(protocol.launchDate).toLocaleDateString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Historical Incidents:</span>
                <span>${protocol.historicalIncidents > 0 ? `‚ö†Ô∏è ${protocol.historicalIncidents}` : '‚úÖ None'}</span>
              </div>
              ${protocol.lastIncidentDate ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-secondary);">Last Incident:</span>
                  <span>${new Date(protocol.lastIncidentDate).toLocaleDateString()}</span>
                </div>
              ` : ''}
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Centralization Risk:</span>
                <span style="text-transform: capitalize;">${protocol.centralizationRisk}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Insurance Fund:</span>
                <span>${protocol.insuranceFund ? '‚úÖ Yes' : '‚ùå No'}</span>
              </div>
            </div>
          </div>

          ${aegisData && (aegisData.insights || aegisData.warnings) ? `
            <div>
              <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">
                <span class="aegis-watermark">üõ°Ô∏è AEGIS Intelligence</span>
              </h3>
              <div class="insight-list">
                ${aegisData.insights.map(insight => `
                  <div class="insight-item positive">
                    <div class="insight-icon">‚úÖ</div>
                    <div>${insight}</div>
                  </div>
                `).join('')}
                ${aegisData.warnings.map(warning => `
                  <div class="insight-item warning">
                    <div class="insight-icon">‚ö†Ô∏è</div>
                    <div>${warning}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;

      modal.classList.add('active');
    }

    function showOpportunityDetails(protocol, asset) {
      const opp = opportunities.find(o => o.protocol === protocol && o.asset === asset);
      if (!opp) return;

      const modal = document.getElementById('protocol-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      const icon = protocolIcons[protocol.toLowerCase()] || 'üì¶';
      title.innerHTML = `${icon} ${protocol} ¬∑ ${asset}`;

      const riskLevel = getRiskLevel(opp.riskScore);
      const riskLabel = getRiskLabel(opp.riskScore);

      body.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div style="padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Raw APY</div>
              <div style="font-size: 1.75rem; font-family: 'JetBrains Mono', monospace; color: var(--neon-green);">${opp.rawApy.toFixed(2)}%</div>
            </div>
            <div style="padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Risk-Adjusted APY</div>
              <div style="font-size: 1.75rem; font-family: 'JetBrains Mono', monospace; color: var(--neon-cyan);">${opp.riskAdjustedApy.toFixed(2)}%</div>
            </div>
            <div style="padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Risk Score</div>
              <div class="risk-number risk-${riskLevel}" style="font-size: 1.75rem;">${opp.riskScore}</div>
              <div class="risk-label risk-${riskLevel}">${riskLabel}</div>
            </div>
            <div style="padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Sharpe Ratio</div>
              <div style="font-size: 1.75rem; font-family: 'JetBrains Mono', monospace; color: var(--neon-purple);">${opp.sharpeRatio.toFixed(2)}</div>
            </div>
          </div>

          <div>
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Risk Factor Breakdown</h3>
            <div class="factor-grid">
              ${Object.entries(opp.riskFactors).map(([key, value]) => `
                <div class="factor-row">
                  <div class="factor-name">${key.replace(/([A-Z])/g, ' $1').trim()}</div>
                  <div class="factor-bar-container">
                    <div class="factor-bar">
                      <div class="factor-bar-fill" style="width: ${value}%; background: ${getFactorColor(value)}"></div>
                    </div>
                    <div class="factor-value" style="color: ${getFactorColor(value)}">${value}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          ${opp.positives && opp.positives.length > 0 ? `
            <div>
              <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Strengths</h3>
              <div class="insight-list">
                ${opp.positives.map(p => `
                  <div class="insight-item positive">
                    <div class="insight-icon">${p.includes('AEGIS') ? 'üõ°Ô∏è' : '‚úÖ'}</div>
                    <div>${p}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          ${opp.warnings && opp.warnings.length > 0 ? `
            <div>
              <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Risks & Warnings</h3>
              <div class="insight-list">
                ${opp.warnings.map(w => `
                  <div class="insight-item warning">
                    <div class="insight-icon">${w.includes('AEGIS') ? 'üõ°Ô∏è' : '‚ö†Ô∏è'}</div>
                    <div>${w}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          ${opp.aegisEnhanced ? `
            <div style="padding: 1rem; background: rgba(179, 102, 255, 0.05); border: 1px solid var(--neon-purple); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
              <span class="aegis-watermark" style="font-size: 0.9rem;">üõ°Ô∏è AEGIS Enhanced</span>
              <p style="margin-top: 0.5rem;">
                This risk score has been enhanced with intelligence from the AEGIS Analyst Agent (${(opp.aegisConfidence * 100).toFixed(0)}% confidence).
              </p>
            </div>
          ` : ''}
        </div>
      `;

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('protocol-modal').classList.remove('active');
    }

    // Close modal on background click
    document.getElementById('protocol-modal').addEventListener('click', (e) => {
      if (e.target.id === 'protocol-modal') closeModal();
    });

    // Init
    fetchProtocols();
    fetchOpportunities();
    setInterval(() => {
      fetchOpportunities();
    }, 60000); // Refresh every minute
  </script>
</body>
</html>
